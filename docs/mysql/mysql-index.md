# Mysql 梳理
---


Mysql 是一种被普遍使用的开源关系型数据库。下面是对 Mysql 一些知识点的整理。

## 存储引擎

引擎（Engine）是机器发动机的核心，而数据库存储引擎便是数据库的底层软件组织。数据库使用数据存储引擎实现存储、处理和保护数据的核心服务。利用数据库引擎可控制访问权限并快速处理事务。不同的存储引擎提供不同的存储机制、索引技巧、锁定水平等功能，MySql 的核心就是插件式存储引擎，可以支持多种不同的数据引擎。目前常见的存储引擎及对比如下：

![](https://jverson.oss-cn-beijing.aliyuncs.com/71f19ff023994d1a80052b36ff3e2dea.jpg)

以下是查看 Mysql 数据库存储引擎的几个常用命令。


```bash
mysql> show engines; # 查看 MySQL 提供的所有存储引擎

mysql> show variables like '%storage_engine%'; # 查看MySQL当前默认的存储引擎

mysql> show table status like "table_name"; # 查看表的存储引擎
```

### MyISAM vs InnoDB

这是最常用也是总放在一起对比的两个存储引擎，上面的图标也基本列出了两者的差异。MyISAM 是 v5.5 之前 MySQL 的默认数据库引擎，而 InnoDB 则是后续版本的默认引擎，也就是所谓的事务性数据库引擎。两者的区别大概总结一下：

- **是否支持行级锁**，MyISAM 只有表级锁(table-level locking)，而 InnoDB 支持行级锁(row-level locking)和表级锁，默认为行级锁。
- **是否支持事务**，MyISAM 强调的是性能，但是不提供事务支持。InnoDB 提供事务支持、外键等高级数据库功能。 具有事务(commit)、回滚(rollback)和崩溃修复能力(crash recovery capabilities)的事务安全(transaction-safe (ACID compliant))型表。
- **是否支持外键**，MyISAM 不支持，InnoDB 支持。
- **是否支持MVCC**，仅 InnoDB 支持。应对高并发事务, MVCC 比单纯的加锁更高效，MVCC 只在 READ COMMITTED 和 REPEATABLE READ 两个隔离级别下工作；MVCC 可以使用乐观(optimistic)锁和悲观(pessimistic)锁来实现；各数据库中 MVCC 实现并不统一。

至于两个存储引擎怎么选择的问题，闭着眼睛用 InnoDB 就完事了，不需要纠结。

### MVCC(Multiversion Concurrency Control)

> **多版本控制**: 指的是一种提高并发的技术。最早的数据库系统，只有读读之间可以并发，读写、写读、写写都要阻塞。引入多版本之后，只有写写之间相互阻塞，其他三种操作都可以并行，这样大幅度提高了 InnoDB 的并发度。在内部实现中，与 Postgres 在数据行上实现多版本不同，InnoDB 是在 undolog 中实现的，通过 undolog 可以找回数据的历史版本。找回的数据历史版本可以提供给用户读(按照隔离级别的定义，有些读请求只能看到比较老的数据版本)，也可以在回滚的时候覆盖数据页上的数据。在 InnoDB 内部中，会记录一个全局的活跃读写事务数组，其主要用来判断事务的可见性。

- 可以认为 MVCC 是行级锁的一个变种, 但是它在很多情况下避免了加锁操作, 因此开销更低。虽然实现机制有所不同, 但大都实现了非阻塞的读操作，写操作也只锁定必要的行。
- MVCC 可以使用乐观(optimistic)锁和悲观(pessimistic)锁来实现;
- 应对高并发事务, MVCC 比单纯的加锁更高效;
- MVCC 只在 READ COMMITTED 和 REPEATABLE READ 两个隔离级别下工作;
- InnoDB 的 MVCC 是通过在每行记录后面保存隐藏的列来实现的

将会在事务的章节中详细讲解。

## 索引

从数据结构角度讲，MySQL 索引主要有 B+Tree 索引和哈希索引。
- **哈希索引**，底层的数据结构就是哈希表，因此在绝大多数需求为单条记录查询的时候，可以选择哈希索引，查询性能最快；
- **B+Tree 索引**，大部分场景建议选择 B+Tree 索引。

MySQL 的 B+Tree 索引还可以分为聚集索引和非聚集索引。

- **聚集索引（聚簇索引/clustered index）**，表数据按照索引的顺序来存储的，也就是说索引项的顺序与表中记录的物理顺序一致。对于聚集索引，叶子结点即存储了真实的数据行，不再有另外单独的数据页。 在一张表上最多只能创建一个聚集索引，因为真实数据的物理顺序只能有一种。
  - 每个 InnoDB 表都有且仅有一个聚簇索引。如果你为表定义了一个主键，MySQL将使用主键作为聚簇索引。如果你不为表指定一个主键，MySQL将第一个组成列都 not null 的唯一索引作为聚簇索引。如果 InnoBD 表没有主键且没有适合的唯一索引，将自动创建一个隐藏的名字为 “GEN_CLUST_INDEX” 的聚簇索引。
  - 聚簇索引是物理索引，数据表就是按索引顺序存储的，物理上是连续的。
  - 主索引文件和数据文件为同一份文件
- **非聚集索引（非聚簇索引/辅助索引/二级索引/secondary index）**，指聚簇索引之外的所有其它的索引。
  - 非聚簇所以可以有多个，而且只能由用户自己添加，InnoDB 默认并不会创建任何非聚簇索引。
  - 对于非聚簇索引存储来说，主键B+树在叶子节点存储指向真正数据行的指针，而非主键。

索引这块后面也将单独章节进行介绍，敬请期待。


## 事务

事务是逻辑上的一组操作，要么都执行，要么都不执行。下面来看看事物的四大特性(ACID)：

- **原子性（Atomicity）**，事务是最小的执行单位，不允许分割。事务的原子性确保动作要么全部完成，要么完全不起作用；
- **一致性（Consistency）**，执行事务前后，数据保持一致，多个事务对同一个数据读取的结果是相同的；
- **隔离性（Isolation）**，并发访问数据库时，一个用户的事务不被其他事务所干扰，各并发事务之间数据库是独立的；
- **持久性（Durability）**，一个事务被提交之后。它对数据库中数据的改变是持久的，即使数据库发生故障也不应该有任何影响。

###  并发事务带来的问题




